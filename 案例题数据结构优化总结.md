# 案例题数据结构优化总结

## 📋 问题描述

案例题的小问题被错误地存储为选项（options），导致数据结构不合理：

### 错误的数据结构

```json
{
  "number": 31,
  "type": "案例题",
  "question": "案例（一）\n背景资料：...",
  "options": {
    "A": "1. 氨制冷站施工前应履行何种手续？",
    "B": "2. 安装公司对容器补焊处理是否合法，说明理由。",
    "C": "3. 事件1吊装作业前还应进行什么工作？",
    "D": "4. 项目部在氨制冷系统强度试验后即进行试运转是否妥当？",
    "E": "5. 项目部所编制的应急预案缺少哪些内容？"
  }
}
```

**问题**:
- ❌ 案例题的小问题不是选项，不应该用A、B、C、D、E标记
- ❌ 每个小问题应该是独立的题目，有独立的题号
- ❌ 无法单独为每个小问题设置答案
- ❌ 不符合实际考试的答题方式

## 🎯 优化方案

### 正确的数据结构

将案例题的每个小问题作为独立的题目：

```json
{
  "number": 31,
  "type": "案例题",
  "question": "【案例（一）】\n\n背景资料：\n某机电安装公司具有压力容器...\n\n问题1：\n氨制冷站施工前应履行何种手续？",
  "options": {},
  "answer": null
},
{
  "number": 32,
  "type": "案例题",
  "question": "【案例（一）】\n\n背景资料：\n某机电安装公司具有压力容器...\n\n问题2：\n安装公司对容器补焊处理是否合法，说明理由。",
  "options": {},
  "answer": null
},
...
```

**优点**:
- ✅ 每个小问题都是独立的题目，有独立的题号
- ✅ 每个题目包含完整的背景资料 + 具体问题
- ✅ 可以单独为每个小问题设置答案
- ✅ 符合实际考试的答题方式
- ✅ 便于后续展示和答题

## 🔧 技术实现

### 修改前的代码

```python
def _parse_case_questions(self, case_section: str, type_ranges: dict) -> List[ExamQuestion]:
    # ... 解析案例题 ...
    
    # 提取小问题
    sub_questions = []
    for sub_num, sub_text in sub_matches:
        sub_questions.append(f"{sub_num}. {sub_text.strip()}")
    
    # ❌ 错误：将小问题作为选项存储
    if sub_questions:
        question.options = {chr(65 + i): q for i, q in enumerate(sub_questions)}
    
    questions.append(question)
```

### 修改后的代码

```python
def _parse_case_questions(self, case_section: str, type_ranges: dict) -> List[ExamQuestion]:
    # ... 解析案例题 ...
    
    # 提取背景资料
    background = ""
    background_match = re.search(r'背景资料(.*?)(?=问\s*题|$)', case_content, re.DOTALL)
    if background_match:
        background = background_match.group(1).strip()
    
    # 提取小问题
    sub_questions = []
    problem_match = re.search(r'问\s*题(.*?)$', case_content, re.DOTALL)
    if problem_match:
        sub_pattern = r'(\d+)[.、．]\s*([^\n]+(?:\n(?!\d+[.、．])[^\n]+)*)'
        sub_matches = re.findall(sub_pattern, problem_section)
        
        for sub_num, sub_text in sub_matches:
            sub_questions.append((sub_num, sub_text.strip()))
    
    # ✅ 正确：为每个小问题创建独立的题目
    if sub_questions:
        for sub_num, sub_text in sub_questions:
            question = ExamQuestion()
            question.number = case_start_num + len(questions)
            question.type = '案例题'
            # 题干 = 案例标题 + 背景资料 + 小问题
            question.question = f"【案例（{case_num_chinese}）】\n\n背景资料：\n{background}\n\n问题{sub_num}：\n{sub_text}"
            question.options = {}  # 案例题没有选项
            questions.append(question)
```

## 📊 优化效果

### 2010年机电实务

#### 优化前
```
总题目数: 35题
题型分布:
  单选题: 20题
  多选题: 10题
  案例题: 5题  ❌ 只有5个案例大题

案例题结构:
  题31: 案例（一）- 包含5个小问题作为选项A-E
  题32: 案例（二）- 包含4个小问题作为选项A-D
  题33: 案例（三）- 包含4个小问题作为选项A-D
  题34: 案例（四）- 包含5个小问题作为选项A-E
  题35: 案例（五）- 包含5个小问题作为选项A-E
```

#### 优化后
```
总题目数: 53题  ✅
题型分布:
  单选题: 20题
  多选题: 10题
  案例题: 23题  ✅ 每个小问题都是独立题目

案例题结构:
  题31: 案例（一）问题1 - 氨制冷站施工前应履行何种手续？
  题32: 案例（一）问题2 - 安装公司对容器补焊处理是否合法？
  题33: 案例（一）问题3 - 事件1吊装作业前还应进行什么工作？
  题34: 案例（一）问题4 - 项目部在氨制冷系统强度试验后即进行试运转是否妥当？
  题35: 案例（一）问题5 - 项目部所编制的应急预案缺少哪些内容？
  题36: 案例（二）问题1 - ...
  ...
  题53: 案例（五）问题5 - ...
```

### 对比表格

| 项目 | 优化前 | 优化后 | 状态 |
|------|--------|--------|------|
| 总题目数 | 35题 | 53题 | ✅ 正确 |
| 案例题数 | 5题（大题） | 23题（小题） | ✅ 正确 |
| 题号范围 | 1-35 | 1-53 | ✅ 正确 |
| 数据结构 | 小问题作为选项 | 小问题作为独立题目 | ✅ 优化 |
| 答题方式 | 不符合实际 | 符合实际 | ✅ 改进 |

## 📋 案例题结构示例

### 原始PDF格式

```
三、案例分析题（共 5 题，（一）、（二）、（三）题各 20 分，（四）、（五）题各 30 分）

（一）
背景资料
某机电安装公司具有压力容器、压力管道安装资格，通过招标承接一高层建筑机电安装工程，
工程内容包括给水排水系统、电气系统、通风空调系统和一座氨制冷站。...

问题
1. 氨制冷站施工前应履行何种手续？
2. 安装公司对容器补焊处理是否合法，说明理由。
3. 事件1吊装作业前还应进行什么工作？应提供哪些资料？
4. 项目部在氨制冷系统强度试验后即进行试运转是否妥当？说明理由。
5. 项目部所编制的应急预案缺少哪些内容？
```

### 解析后的JSON格式

```json
[
  {
    "number": 31,
    "type": "案例题",
    "question": "【案例（一）】\n\n背景资料：\n某机电安装公司具有压力容器、压力管道安装资格，通过招标承接一高层建筑机电安装工程，\n工程内容包括给水排水系统、电气系统、通风空调系统和一座氨制冷站。...\n\n问题1：\n氨制冷站施工前应履行何种手续？",
    "options": {},
    "answer": null,
    "year": 2010,
    "subject": "机电实务"
  },
  {
    "number": 32,
    "type": "案例题",
    "question": "【案例（一）】\n\n背景资料：\n某机电安装公司具有压力容器、压力管道安装资格，通过招标承接一高层建筑机电安装工程，\n工程内容包括给水排水系统、电气系统、通风空调系统和一座氨制冷站。...\n\n问题2：\n安装公司对容器补焊处理是否合法，说明理由。",
    "options": {},
    "answer": null,
    "year": 2010,
    "subject": "机电实务"
  }
]
```

## 🎯 优化优点

### 1. 符合实际考试场景

- ✅ 每个小问题独立作答
- ✅ 每个小问题有独立的分值
- ✅ 每个小问题可以单独评分

### 2. 便于数据管理

- ✅ 统一的数据结构（所有题目都有number、type、question、options、answer）
- ✅ 便于统计（总题目数、答案率等）
- ✅ 便于查询和筛选

### 3. 便于前端展示

- ✅ 可以按题号顺序展示
- ✅ 可以单独显示每个小问题
- ✅ 可以为每个小问题提供答题框

### 4. 便于答案管理

- ✅ 每个小问题可以单独设置答案
- ✅ 便于答案提取和匹配
- ✅ 便于答案验证

## 📈 全部年份统计

### 2009年机电实务
- 总题目数: 55题
- 单选题: 20题
- 多选题: 10题
- 案例题: 25题（5个案例，每个案例5个小问题）

### 2010年机电实务
- 总题目数: 53题
- 单选题: 20题
- 多选题: 10题
- 案例题: 23题（5个案例，共23个小问题）

### 2011年机电实务
- 总题目数: 82题
- 单选题: 20题
- 多选题: 10题
- 案例题: 52题（5个案例，共52个小问题）

## 💡 技术要点

### 1. 背景资料提取

```python
background_match = re.search(r'背景资料(.*?)(?=问\s*题|$)', case_content, re.DOTALL)
if background_match:
    background = background_match.group(1).strip()
```

### 2. 小问题提取

```python
problem_match = re.search(r'问\s*题(.*?)$', case_content, re.DOTALL)
if problem_match:
    problem_section = problem_match.group(1)
    sub_pattern = r'(\d+)[.、．]\s*([^\n]+(?:\n(?!\d+[.、．])[^\n]+)*)'
    sub_matches = re.findall(sub_pattern, problem_section)
```

### 3. 题目组装

```python
question.question = f"【案例（{case_num_chinese}）】\n\n背景资料：\n{background}\n\n问题{sub_num}：\n{sub_text}"
```

## ✅ 验证结果

```bash
python exam_parser.py
```

**输出**:
```
📄 正在解析: 2010年一级建造师机电考试真题及答案解析.pdf
  📋 找到 5 个案例题
  ✅ 解析完成，共提取 53 道题目

题型分布:
  单选题: 20题
  多选题: 10题
  案例题: 23题

题号验证:
  题号范围: 1-53
  题号数量: 53
  是否连续: ✅ 是
```

## 🎓 总结

通过本次优化：
1. ✅ 案例题的小问题作为独立题目存储
2. ✅ 每个题目包含完整的背景资料和具体问题
3. ✅ 数据结构统一，便于管理和展示
4. ✅ 符合实际考试场景和答题方式
5. ✅ 便于后续答案提取和验证

**关键改进**:
- 将案例题的小问题从选项（options）改为独立题目
- 每个题目包含完整的背景资料
- 题号连续，便于统计和管理

现在2010年机电实务的数据结构完全正确，可以为一建机电备考提供更好的支持！

